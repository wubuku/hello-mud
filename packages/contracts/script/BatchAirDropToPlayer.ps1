$worldAddress = "0x776086899eab4ee3953b7c037b2c0a13c7a1deed"
$rpc_url = "https://odyssey.storyrpc.io/"
$privateKey = "0x70fc6e2715bfd632dcdbe86657bc9b38e3f48b6d866171ed61ae60f3d42a57e1"

$startLocation = $PSScriptRoot; 
Set-Location $startLocation


$logPath = $startLocation + "\BatchAirdropToPlayers\$worldAddress"
if (-Not (Test-Path $logPath)) {
    # 如果不存在，则创建目录
    New-Item -ItemType Directory -Path $logPath
    Write-Host "目录已创建: $logPath"
} 

$now = Get-Date
$formattedNow = $now.ToString('yyyyMMddHHmmss')
$logFile = "$logPath\$formattedNow.log"

$playerIds = @(
    "61"
    "14"
    "93"
    "34"
    "134"
    "70"
    "72"
    "49"
    "211"
    "207"
    "198"
    "188"
    "165"
    "87"
    "77"
    "68"
    "63"
    "28"
    "79"
    "578"
    "57"
    "556"
    "528"
    "458"
    "376"
    "351"
    "347"
    "256"
    "209"
    "184"
    "166"
    "155"
    "153"
    "50"
    "5"
    "45"
    "243"
    "156"
    "144"
    "4"
    "107"
    "720"
    "708"
    "704"
    "699"
    "693"
    "636"
    "610"
    # "605"
    # "603"
    # "600"
    # "6"
    # "599"
    # "573"
    # "563"
    # "561"
    # "551"
    # "545"
    # "530"
    # "510"
    # "509"
    # "483"
    # "472"
    # "464"
    # "457"
    # "442"
    # "418"
    # "337"
    # "316"
    # "312"
    # "266"
    # "263"
    # "230"
    # "202"
    # "200"
    # "185"
    # "122"
    # "302"
    # "262"
    # "250"
    # "231"
    # "212"
    # "183"
    # "142"
    # "11"
    # "102"
    # "576"
    # "60"
    # "15"
    # "730"
    # "715"
    # "700"
    # "678"
    # "645"
    # "644"
    # "621"
    # "502"
    # "385"
    # "350"
    # "241"
    # "205"
    # "113"
    # "112"
    # "101"
    # "9"
    # "707"
    # "65"
    # "64"
    # "614"
    # "543"
    # "514"
    # "469"
    # "437"
    # "40"
    # "329"
    # "296"
    # "292"
    # "290"
    # "234"
    # "218"
    # "193"
    # "181"
    # "137"
    # "728"
    # "7"
    # "23"
    # "19"
    # "179"
    # "740"
    # "725"
    # "92"
    # "8"
    # "75"
    # "690"
    # "670"
    # "548"
    # "51"
    # "499"
    # "475"
    # "392"
    # "308"
    # "274"
    # "260"
    # "247"
    # "213"
    # "186"
    # "143"
    # "13"
    # "126"
    # "121"
    # "105"
    # "76"
    # "59"
    # "133"
    # "694"
    # "688"
    # "658"
    # "643"
    # "640"
    # "608"
    # "566"
    # "56"
    # "55"
    # "532"
    # "520"
    # "47"
    # "468"
    # "460"
    # "43"
    # "387"
    # "326"
    # "259"
    # "222"
    # "215"
    # "12"
    # "96"
    # "711"
    # "69"
    # "533"
    # "504"
    # "497"
    # "479"
    # "423"
    # "407"
    # "394"
    # "386"
    # "322"
    # "30"
    # "277"
    # "26"
    "189"
    "742"
    "501"
    "747"
    "746"
    "662"
    "424"
    "330"
    "88"
    "78"
    "71"
    "695"
    "66"
    "633"
    "623"
    "613"
    "575"
    "54"
    "531"
    "447"
    "421"
    "390"
    "382"
    "355"
    "339"
    "310"
    "309"
    "305"
    "280"
    "255"
    "244"
    "242"
    "199"
    "197"
    "157"
    "135"
    "127"
    "718"
    "114"
    "98"
    "97"
    "95"
    "94"
    "89"
    "86"
    "85"
    "84"
    "83"
    "82"
    "81"
    "80"
    "74"
    "739"
    "736"
    "73"
    "714"
    "712"
    "710"
    "709"
    "706"
    "705"
    "703"
    "702"
    "701"
    "698"
    "696"
    "692"
    "689"
    "687"
    "685"
    "683"
    "682"
    "681"
    "674"
    "673"
    "672"
    "671"
    "67"
    "669"
    "664"
    "663"
    "661"
    "660"
    "657"
    "656"
    "654"
    "653"
    "652"
    "650"
    "648"
    "647"
    "646"
    "637"
    "634"
    "628"
    "626"
    "625"
    "624"
    "622"
    "620"
    "62"
    "619"
    "617"
    "616"
    "615"
    "609"
    "607"
    "604"
    "602"
    "601"
    "598"
    "597"
    "596"
    "595"
    "594"
    "593"
    "591"
    "589"
    "588"
    "587"
    "583"
    "581"
    "580"
    "58"
    "579"
    "577"
    "574"
    "572"
    "569"
    "568"
    "567"
    "562"
    "560"
    "559"
    "558"
    "557"
    "553"
    "552"
    "550"
    "544"
    "542"
    "541"
    "540"
    "539"
    "538"
    "537"
    "536"
    "535"
    "534"
    "527"
    "526"
    "525"
    "524"
    "523"
    "522"
    "52"
    "519"
    "518"
    "517"
    "515"
    "513"
    "512"
    "511"
    "507"
    "506"
    "505"
    "503"
    "498"
    "495"
    "494"
    "493"
    "492"
    "491"
    "490"
    "489"
    "488"
    "487"
    "486"
    "485"
    "484"
    "482"
    "481"
    "480"
    "48"
    "476"
    "474"
    "473"
    "466"
    "465"
    "463"
    "462"
    "461"
    "46"
    "456"
    "455"
    "449"
    "444"
    "440"
    "439"
    "434"
    "433"
    "432"
    "431"
    "430"
    "429"
    "428"
    "427"
    "426"
    "425"
    "422"
)


"$($playerIds.Count)" | Write-Host  -ForegroundColor Blue
# $itemdIds = "[2, 2000000001, 2000000003]" 
# $quanities = "[200, 200, 200]"
$itemIds = @(2, 2000000001, 2000000003)
$quanities = @(200, 200, 200)

$errorTimes = 0
$maxErrorTimes = 5


"一共需要给 $($playerIds.Count) 个用户空投资源." | Tee-Object -FilePath $logFile -Append | Write-Host  -ForegroundColor Blue

$airdroppedQuantity = 1
foreach ($playerId in $playerIds) {
    "现在空投给用户:$playerId" | Tee-Object -FilePath $logFile -Append | Write-Host  -ForegroundColor Blue
    $allItemsSucceed = $true
    for ($i = 0; $i -lt $itemIds.count; $i++) {
        $airdroppedResult = ""
        try {
            $command = "cast send $worldAddress ""app__playerAirdrop(uint256,uint32,uint32)"" $playerId $($itemIds[$i]) $($quanities[$i]) --rpc-url $rpc_url --private-key $privateKey --json"
            $command | Tee-Object -FilePath $logFile -Append | Write-Host  -ForegroundColor Blue
            $airdroppedResult = Invoke-Expression -Command "$command 2>&1"
            if ($airdroppedResult -match "error" -or $airdroppedResult -match "failed") {
                throw "Cast command failed: $airdroppedResult"
            }
            $airdroppedResultObj = $airdroppedResult | ConvertFrom-Json
            if (-not $airdroppedResultObj.status) {                
                throw "Transaction failed: $airdroppedResult"
            }
            "空投 ItemId:$($itemIds[$i]) 成功,交易哈希: $($airdroppedResultObj.transactionHash),blockNumber:$($airdroppedResultObj.blockNumber)" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Green
        }
        catch { 
            $allItemsSucceed = $false
            $errorMessage = if ($_.Exception.Message) { $_.Exception.Message } else { $_ }
            "空投失败{PlayerId:$playerId,ItemId:$($itemIds[$i])}: $errorMessage" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Red
            "完整错误信息: $airdroppedResult" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Red    
            $errorTimes++
            if ($errorTimes -ge $maxErrorTimes) {
                "空投出错次数:$errorTimes,已经达到上限:$maxErrorTimes,退出..." | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Red
                "查看日志`n:$logFile" | Write-Host -ForegroundColor Blue
                return
            }
            continue    
        }
    }
    if ($allItemsSucceed) {
        "已经空投给 $($airdroppedQuantity) 个用户，还剩余$($playerIds.Count-$airdroppedQuantity)" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Green
        $airdroppedQuantity++;
    }
}
"查看日志`n:$logFile" | Write-Host -ForegroundColor Blue

