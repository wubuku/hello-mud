$worldAddress = "0x776086899eab4ee3953b7c037b2c0a13c7a1deed"
$rpc_url = "https://odyssey.storyrpc.io/"
$privateKey = "0x70fc6e2715bfd632dcdbe86657bc9b38e3f48b6d866171ed61ae60f3d42a57e1"

$startLocation = $PSScriptRoot; 
Set-Location $startLocation


$logPath = $startLocation + "\BatchAirdropToPlayers\$worldAddress"
if (-Not (Test-Path $logPath)) {
    # 如果不存在，则创建目录
    New-Item -ItemType Directory -Path $logPath
    Write-Host "目录已创建: $logPath"
} 

$now = Get-Date
$formattedNow = $now.ToString('yyyyMMddHHmmss')
$logFile = "$logPath\$formattedNow.log"

$playerIds = @(
    # "28"
    # "376"
    # "166"
    # "4"
    # "600"
    # "234"
    # "573"
    # "543"
    # "530"
    # "528"
    # "720"
    # "502"
    # "57"
    # "211"
    # "212"
    # "728"
    # "509"
    # "5"
    # "510"
    # "277"
    "68"
    "483"
    "63"
    "45"
    "93"
    "49"
    "266"
    "207"
    "87"
    "768"
    "337"
    "77"
    "412"
    "704"
    "13"
    "215"
    "730"
    "231"
    "387"
    "156"
    "645"
    "614"
    "497"
    "753"
    "61"
    "6"
    "494"
    "694"
    "179"
    "740"
    "256"
    "644"
    "472"
    "563"
    "230"
    "751"
    "561"
    "155"
    "756"
    "250"
    "760"
    "184"
    "643"
    "347"
    "102"
    "7"
    "746"
    "40"
    "19"
    "765"
    "153"
    "566"
    "605"
    "262"
    "578"
    "708"
    "144"
    "548"
    "780"
    "640"
    "662"
    "122"
    "610"
    "661"
    "442"
    "260"
    "200"
    "185"
    "316"
    "750"
    "14"
    "458"
    "782"
    "464"
    "764"
    "142"
    "165"
    "1"
    "437"
    "188"
    "783"
    "636"
    "263"
    "556"
    "700"
    "54"
    "290"
    "792"
    "769"
    "475"
    "241"
    "181"
    "134"
    "70"
    "50"
    "603"
    "113"
    "198"
    "72"
    "557"
    "79"
    "621"
    "101"
    "193"
    "690"
    "64"
    "15"
    "623"
    "499"
    "747"
    "715"
    "11"
    "209"
    "96"
    "793"
    "243"
    "3"
    "392"
    "551"
    "423"
    "394"
    "105"
    "8"
    "789"
    "112"
    "92"
    "418"
    "385"
    "339"
    "312"
    "126"
    "791"
    "576"
    "255"
    "228"
    "712"
    "355"
    "34"
    "244"
    "117"
    "501"
    "107"
    "794"
    "161"
    "183"
    "205"
    "351"
    "296"
    "699"
    "693"
    "678"
    "599"
    "545"
    "457"
    "213"
    "407"
    "386"
    "302"
    "202"
    "779"
    "60"
    "604"
    "468"
    "252"
    "9"
    "65"
    "480"
    "479"
    "47"
    "222"
    "143"
    "498"
    "329"
    "218"
    "725"
    "460"
    "415"
    "308"
    "274"
    "247"
    "133"
    "130"
    "504"
    "738"
    "583"
    "55"
    "484"
    "424"
    "350"
    "186"
    "803"
    "707"
    "658"
    "608"
    "514"
    "469"
    "292"
    "189"
    "187"
    "175"
    "145"
    "137"
    "121"
    "76"
    "711"
    "23"
    "191"
    "767"
    "75"
    "670"
    "527"
    "51"
    "421"
    "742"
    "69"
    "59"
    "382"
    "199"
    "157"
    "688"
    "650"
    "595"
    "56"
    "532"
    "520"
    "465"
    "43"
    "373"
    "326"
    "259"
    "257"
    "128"
    "12"
    "116"
    "71"
    "613"
    "533"
    "322"
    "30"
    "26"
    "788"
    "330"
    "88"
    "78"
    "695"
    "67"
    "660"
    "66"
    "633"
    "575"
    "558"
    "531"
    "511"
    "507"
    "474"
    "447"
    "390"
    "35"
    "324"
    "313"
    "310"
    "309"
    "305"
    "280"
    "242"
    "235"
    "197"
    "135"
    "127"
    "796"
    "787"
    "718"
    "114"
    "98"
    "97"
    "95"
    "94"
    "89"
    "86"
    "85"
    "84"
    "83"
    "82"
    "81"
    "80"
    "74"
    "739"
    "736"
    "73"
    "726"
    "714"
    "710"
    "709"
    "706"
    "705"
    "703"
    "702"
    "701"
    "698"
    "696"
    "692"
    "689"
    "687"
    "685"
    "683"
    "682"
    "681"
    "674"
    "673"
    "672"
    "671"
    "669"
    "664"
    "663"
    "657"
    "656"
    "654"
    "653"
    "652"
    "648"
    "647"
    "646"
    "637"
    "634"
    "628"
    "626"
    "625"
    "624"
    "622"
    "620"
    "62"
    "619"
    "617"
    "616"
    "615"
    "609"
    "607"
    "602"
    "601"
    "598"
    "597"
    "596"
    "594"
    "593"
    "591"
    "589"
    "588"
    "587"
    "581"
    "580"
    "58"
    "579"
    "577"
    "574"
    "572"
    "569"
    "568"
    "567"
    "562"
    "560"
    "559"
    "553"
    "552"
    "550"
    "544"
    "542"
    "541"
    "540"
    "539"
    "538"
    "537"
    "536"
    "535"
    "534"
    "526"
    "525"
    "524"
    "523"
    "522"
    "52"
    # "519"
    # "518"
    # "517"
    # "515"
    # "513"
    # "512"
    # "506"
    # "505"
    # "503"
    # "495"
    # "493"
    # "492"
    # "491"
    # "490"
    # "489"
    # "488"
    # "487"
    # "486"
    # "485"
    # "482"
    # "481"
    # "48"
    # "476"
    # "473"
    # "466"
    # "463"
    # "462"
    # "461"
    # "46"
    # "456"
    # "455"
    # "449"
    # "444"
    # "440"
    # "439"
    # "434"
    # "433"
    # "432"
    # "431"
    # "430"
    # "429"
    # "428"
    # "427"
    # "426"
    # "425"
    # "422"
    # "42"
    # "419"
    # "417"
    # "416"
    # "414"
    # "413"
    # "411"
    # "410"
    # "41"
    # "409"
    # "408"
    # "405"
    # "404"
    # "402"
    # "401"
    # "399"
    # "397"
    # "396"
    # "395"
    # "393"
    # "391"
    # "39"
    # "389"
    # "384"
    # "383"
    # "381"
    # "380"
    # "379"
    # "378"
    # "377"
    # "375"
    # "372"
    # "371"
    # "37"
    # "369"
    # "368"
    # "367"
    # "366"
    # "365"
    # "361"
    # "36"
    # "359"
    # "358"
    # "357"
    # "356"
    # "354"
    # "353"
    # "352"
    # "349"
    # "346"
    # "345"
    # "344"
    # "343"
    # "341"
    # "340"
    # "336"
    # "334"
    # "333"
    # "332"
    # "331"
    # "328"
    # "327"
    # "325"
    # "323"
    # "320"
    # "32"
    # "318"
    # "315"
    # "314"
    # "311"
    # "31"
    # "307"
    # "306"
    # "304"
    # "303"
    # "301"
    # "300"
    # "299"
    # "297"
    # "295"
    # "293"
    # "289"
    # "288"
    # "287"
    # "286"
    # "285"
    # "284"
    # "283"
    # "282"
    # "281"
    # "279"
    # "278"
    # "276"
    # "275"
    # "273"
    # "272"
    # "271"
    # "270"
    # "269"
    # "268"
    # "267"
    # "264"
    # "258"
    # "254"
    # "253"
    # "251"
    # "25"
    # "249"
    # "248"
    # "246"
    # "245"
    # "240"
    # "239"
    # "238"
    # "236"
    # "232"
    # "229"
    # "225"
    # "221"
    # "219"
    # "217"
    # "216"
    # "214"
    # "210"
    # "21"
    # "208"
    # "204"
    # "203"
    # "201"
    # "20"
    # "196"
    # "194"
    # "192"
    # "190"
    # "182"
    # "180"
    # "178"
    # "177"
    # "176"
    # "174"
    # "172"
    # "170"
    # "17"
    # "167"
    # "160"
    # "159"
    # "154"
    # "152"
    # "148"
    # "146"
    # "141"
    # "139"
    # "138"
    # "132"
    # "131"
    # "124"
    # "111"
    # "109"
    # "108"
    # "103"
    # "100"
    # "786"
    # "115"
    # "734"
    # "91"
    # "680"
    # "639"
    # "629"
    # "516"
    # "508"
    # "459"
    # "400"
    # "398"
    # "38"
    # "364"
    # "363"
    # "335"
    # "321"
    # "291"
    # "29"
    # "265"
    # "261"
    # "226"
    # "220"
    # "206"
    # "195"
    # "18"
    # "173"
    # "169"
    # "163"
    # "158"
    # "150"
    # "140"
    # "797"
    # "778"
    # "766"
    # "755"
    # "590"
    # "342"
    # "168"
    # "16"
    # "679"
    # "2"
    # "795"
    # "641"
    # "99"
    # "90"
    # "802"
    # "801"
    # "790"
    # "784"
    # "774"
    # "763"
    # "761"
    # "752"
    # "735"
    # "717"
    # "713"
    # "697"
    # "686"
    # "675"
    # "638"
    # "612"
    # "585"
    # "584"
    # "582"
    # "564"
    # "529"
    # "477"
    # "453"
    # "441"
    # "374"
    # "233"
    # "162"
    # "129"
    # "684"
    # "665"
    # "798"
    # "781"
    # "723"
    # "691"
    # "655"
    # "521"
    # "338"
    # "22"
    # "804"
    # "799"
    # "777"
    # "776"
    # "775"
    # "773"
    # "772"
    # "771"
    # "770"
    # "759"
    # "758"
    # "757"
    # "724"
    # "716"
    # "677"
    # "651"
    # "635"
    # "631"
    # "618"
    # "606"
    # "571"
    # "554"
    # "496"
    # "478"
    # "470"
    # "452"
    # "360"
    # "27"
    # "120"
    # "805"
    # "800"
    # "785"
    # "762"
    # "754"
    # "749"
    # "748"
    # "745"
    # "744"
    # "743"
    # "741"
    # "737"
    # "733"
    # "732"
    # "731"
    # "729"
    # "727"
    # "722"
    # "721"
    # "719"
    # "676"
    # "668"
    # "667"
    # "666"
    # "659"
    # "649"
    # "642"
    # "632"
    # "630"
    # "627"
    # "611"
    # "592"
    # "586"
    # "570"
    # "565"
    # "555"
    # "549"
    # "547"
    # "546"
    # "53"
    # "500"
    # "471"
    # "467"
    # "454"
    # "451"
    # "450"
    # "448"
    # "446"
    # "445"
    # "443"
    # "44"
    # "438"
    # "436"
    # "435"
    # "420"
    # "406"
    # "403"
    # "388"
    # "370"
    # "362"
    # "348"
    # "33"
    # "319"
    # "317"
    # "298"
    # "294"
    # "24"
    # "237"
    # "227"
    # "224"
    # "223"
    # "171"
    # "164"
    # "151"
    # "149"
    # "147"
    # "136"
    # "125"
    # "123"
    # "119"
    # "118"
    # "110"
    # "106"
    # "104"
    # "10"
)

# $itemdIds = "[2, 2000000001, 2000000003]" 
# $quanities = "[200, 200, 200]"
$itemIds = @(2, 2000000001, 2000000003)
$quanities = @(200, 200, 200)

$errorTimes = 0
$maxErrorTimes = 20


"一共需要给 $($playerIds.Count) 个用户空投资源." | Tee-Object -FilePath $logFile -Append | Write-Host  -ForegroundColor Yellow

$airdroppedQuantity = 1
foreach ($playerId in $playerIds) {
    "现在空投给用户:$playerId" | Tee-Object -FilePath $logFile -Append | Write-Host  -ForegroundColor White
    $allItemsSucceed = $true
    for ($i = 0; $i -lt $itemIds.count; $i++) {
        $airdroppedResult = ""
        try {
            $command = "cast send $worldAddress ""app__playerAirdrop(uint256,uint32,uint32)"" $playerId $($itemIds[$i]) $($quanities[$i]) --rpc-url $rpc_url --private-key $privateKey --json"
            $command | Tee-Object -FilePath $logFile -Append | Write-Host  -ForegroundColor Yellow
            $airdroppedResult = Invoke-Expression -Command "$command 2>&1"
            if ($airdroppedResult -match "error" -or $airdroppedResult -match "failed") {
                throw "Cast command failed: $airdroppedResult"
            }
            $airdroppedResultObj = $airdroppedResult | ConvertFrom-Json
            if (-not $airdroppedResultObj.status) {                
                throw "Transaction failed: $airdroppedResult"
            }
            "空投 ItemId:$($itemIds[$i]) 成功,交易哈希: $($airdroppedResultObj.transactionHash),blockNumber:$($airdroppedResultObj.blockNumber)" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Green
        }
        catch { 
            $allItemsSucceed = $false
            $errorMessage = if ($_.Exception.Message) { $_.Exception.Message } else { $_ }
            "空投失败{PlayerId:$playerId,ItemId:$($itemIds[$i])}: $errorMessage" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Red
            "完整错误信息: $airdroppedResult" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Red    
            $errorTimes++
            if ($errorTimes -ge $maxErrorTimes) {
                "空投出错次数:$errorTimes,已经达到上限:$maxErrorTimes,退出..." | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Red
                "查看日志`n:$logFile" | Write-Host -ForegroundColor Blue
                return
            }
            continue    
        }
    }
    if ($allItemsSucceed) {
        "已经空投给 $($airdroppedQuantity) 个用户，还剩余$($playerIds.Count-$airdroppedQuantity)" | Tee-Object -FilePath $logFile -Append | Write-Host -ForegroundColor Green
        $airdroppedQuantity++;
    }
}
"查看日志`n:$logFile" | Write-Host -ForegroundColor Blue

